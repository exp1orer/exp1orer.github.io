<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="TL;DR  本文将讲述在学习了PHP的基本语法结构及开发后如何进行简单的代码审计, 涵盖常见的Web漏洞讲述如何挖掘并利用, 结合代码的实际操作让读者更加通俗易懂! 考虑文章篇幅及读者内容消化的原因, 故本文会分为基础与进阶两部分, 基础部分更多讲述漏洞原理, 通过靶场的漏洞环境让读者更加切实的感受漏洞挖掘和利用的过程, 在进阶的部分文章中会讲述在面对ThinkPHP等MVC框架中, 我们又该如">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP代码审计入门">
<meta property="og:url" content="http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="Search is Null">
<meta property="og:description" content="TL;DR  本文将讲述在学习了PHP的基本语法结构及开发后如何进行简单的代码审计, 涵盖常见的Web漏洞讲述如何挖掘并利用, 结合代码的实际操作让读者更加通俗易懂! 考虑文章篇幅及读者内容消化的原因, 故本文会分为基础与进阶两部分, 基础部分更多讲述漏洞原理, 通过靶场的漏洞环境让读者更加切实的感受漏洞挖掘和利用的过程, 在进阶的部分文章中会讲述在面对ThinkPHP等MVC框架中, 我们又该如">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/dvwa_sql_low.png">
<meta property="og:image" content="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/dvwa_sql_low_2.png">
<meta property="og:image" content="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/xhcms_sql_1.png">
<meta property="og:image" content="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/xhcms_sql_2.png">
<meta property="og:image" content="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/xhcms_sql_3.png">
<meta property="og:image" content="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/xhcms_sql_4.png">
<meta property="og:image" content="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/welive_delete.png">
<meta property="og:image" content="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/welive_delete_2.png">
<meta property="og:image" content="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/welive_delete_3.png">
<meta property="og:image" content="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/welive_delete_4.png">
<meta property="og:image" content="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/welive_delete_5.png">
<meta property="og:image" content="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/welive_download.png">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gkuhlfgpp3j313q0gewiv.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gkuhz4d7kvj31920u0npd.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gkuicby054j314x0u0tk1.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gkz45dd99fj31120u0k4r.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gkz4c0zrl8j315x0u0gqg.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gkz4d83mk9j31uq0jozpq.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gkz5smczdjj32540dkq7z.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gkz69rzyqpj32240bsdks.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gkz7wjink7j31370u045g.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gkzdt5vzsmj317w0gkjtp.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gkzdunu6glj31dz0u0jvk.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gkzeddi3uyj31e60u0aea.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gkzf4xurlbj31e60t2448.jpg">
<meta property="article:published_time" content="2020-11-17T05:26:51.000Z">
<meta property="article:modified_time" content="2020-12-23T15:34:20.226Z">
<meta property="article:author" content="Search?&#x3D;Null">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/dvwa_sql_low.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>PHP代码审计入门</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="Search is Null" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 4.2.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/exp1orer" target="_blank" rel="noopener">项目</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/11/17/CVE-2020-26935-phpmyadminSQL%E6%B3%A8%E5%85%A5%E5%A4%8D%E7%8E%B0/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/11/11/%E5%BC%BA%E7%BD%91%E6%9D%AF2020-web%E8%BE%85%E5%8A%A9Write-Up/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&text=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&title=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&is_video=false&description=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PHP代码审计入门&body=Check out this article: http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&title=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&title=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&title=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&title=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&name=PHP代码审计入门&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&t=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#TL-DR"><span class="toc-number">1.</span> <span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#前序知识"><span class="toc-number">2.</span> <span class="toc-text">前序知识</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL注入"><span class="toc-number">3.</span> <span class="toc-text">SQL注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#熊海CMS-V1-0-SQL注入"><span class="toc-number">4.</span> <span class="toc-text">熊海CMS V1.0 SQL注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#任意文件删除"><span class="toc-number">5.</span> <span class="toc-text">任意文件删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#任意文件下载"><span class="toc-number">6.</span> <span class="toc-text">任意文件下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#任意文件上传"><span class="toc-number">7.</span> <span class="toc-text">任意文件上传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#文件包含"><span class="toc-number">8.</span> <span class="toc-text">文件包含</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XSS"><span class="toc-number">9.</span> <span class="toc-text">XSS</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        PHP代码审计入门
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Search is Null</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-11-17T05:26:51.000Z" itemprop="datePublished">2020-11-17</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h4 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h4><p>  本文将讲述在学习了PHP的基本语法结构及开发后如何进行简单的代码审计, 涵盖常见的Web漏洞讲述如何挖掘并利用, 结合代码的实际操作让读者更加通俗易懂! 考虑文章篇幅及读者内容消化的原因, 故本文会分为基础与进阶两部分, 基础部分更多讲述漏洞原理, 通过靶场的漏洞环境让读者更加切实的感受漏洞挖掘和利用的过程, 在进阶的部分文章中会讲述在面对ThinkPHP等MVC框架中, 我们又该如何去审计这样的源码呢? 并通过漏洞复现的形式加深代码审计的能力。</p>
<p>  个人认为代码审计主要可以分为两个方向去挖掘漏洞：<br>  一是通过针对一些敏感函数的追踪分析其变量是否可控, 如命令执行的system, passthru, shell_exec, exec等函数, 代码执行的eval函数, 文件操作的file_get_contents, fopen, read等等。<br>  二是通过通读整套源码熟悉完整的业务流程去分析挖掘, 当前这种方法会更加耗时费力, 个人而言这种方法只适用于一些小型的CMS建站系统或逻辑较为简单的程序。</p>
<h4 id="前序知识"><a href="#前序知识" class="headerlink" title="前序知识"></a>前序知识</h4><ul>
<li>基础语法结构</li>
<li>面向对象</li>
<li>debug调试</li>
<li>SQL知识</li>
</ul>
<h4 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h4><p>  SQL注入是一个较为常见的漏洞了, 其原理就在于开发者在编写SQL语句时将用户的输入与SQL语句进行拼接并没有任何保护而导致的. 本章节引用Dvwa靶场进行代码分析。<br><img src="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/dvwa_sql_low.png" alt=""></p>
<p>如上图注解所示, 在接收了参数值后程序并没有做任何处理就进行SQL语句的拼接导致了注入, SQL语句：</p>
<blockquote>
<p>SELECT first_name, last_name FROM users WHERE user_id = ‘$id’;</p>
</blockquote>
<p>注意在上面的SQL语句里, WHERE条件的user_id值我们可控, 那么我们就可以通过单引号闭合前面的WHERE条件并使其查询失败, 然后通过union联合查询数据库名, 在使用union联合查询时后者查询的列数必须与前者保持一致, 因为前面的单引号闭合了WHERE条件的值所以在SQL语句的结尾中还剩下一个单引号, 此时可以通过注释或闭合的方式解决.<br><img src="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/dvwa_sql_low_2.png" alt=""></p>
<p>在上图中我们可以看到注入了恶意的查询语句后, 能够成功获取当前的数据库名. 而原本的SQL语句在经过拼接注入的内容后就变成了这样：</p>
<blockquote>
<p>SELECT first_name, last_name FROM users WHERE userid = ‘-1’ union select null, database()– ‘</p>
</blockquote>
<p>以上的环境在现代的Web应用程序中可能较少存在, 但在部分小型的CMS（内容管理系统）中还是可以见到一些开发者在缺乏安全开发意识的情况下使用用户输入的内容直接拼接SQL语句, 而下面的实战分析就是这样的一个例子.</p>
<h4 id="熊海CMS-V1-0-SQL注入"><a href="#熊海CMS-V1-0-SQL注入" class="headerlink" title="熊海CMS V1.0 SQL注入"></a>熊海CMS V1.0 SQL注入</h4><p><img src="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/xhcms_sql_1.png" alt=""><br>在上图中可以看到程序在安装时会向数据库更新一条管理员信息, 而此时拼接的$user变量是从POST接收的参数值.<br><img src="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/xhcms_sql_2.png" alt=""><br>变量可控且无过滤或转义, 并且该SQL语句执行失败时会打印报错信息, 那么我们就可以使用报错注入来获取数据库信息了。<br>Payload：admin&#39; and updatexml(1,concat(0x7e,database(),0x7e),1)#<br><img src="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/xhcms_sql_3.png" alt=""><br><img src="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/xhcms_sql_4.png" alt=""></p>
<h4 id="任意文件删除"><a href="#任意文件删除" class="headerlink" title="任意文件删除"></a>任意文件删除</h4><p>  通常这类漏洞出现在unlink函数中, 所以在挖掘这种漏洞时我们可以通过全局搜索该函数并回溯其变量是否可控来判断是否存在漏洞. 当然, 通过其他的方式或间接调用其他的函数也能够达到删除文件的功能, 本章节只是针对此类漏洞的一个基础挖掘讲解.<br>  <strong>WeLive V5.8.0在线客服系统后台任意文件删除</strong><br><img src="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/welive_delete.png" alt=""><br>通过全局搜索的方法找到几处使用了unlink函数的地方, 逐一跟进代码逆推其变量是否可控.<br><img src="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/welive_delete_2.png" alt=""><br>在上图中我们可以看到, 当$action变量为delete时会进入elseif 分支, 首先进行了一个权限验证, 然后在第57的if中调用了unlink函数, 参数是backupDir加$filename变量, 此时继续跟进$filename变量调用的函数ForceStringFrom查看其是否可控.<br><img src="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/welive_delete_3.png" alt=""><br>通过分析上图代码可以得知, 在调用ForceStringFrom函数并传入参数<strong>file</strong>时, ForceStringFrom函数会做这几件事：</p>
<ul>
<li>判断GET数组里是否有file参数, 有则调用ForceString函数然后返回</li>
<li>上面条件不成立时进入elseif, 判断POST数组里是否有file参数, 然后执行跟上面一样的操作</li>
<li>当如上两个条件都不成立时则返回空</li>
</ul>
<p>ForceString函数又是干嘛的呢?</p>
<ul>
<li>判断传入的参数是否字符串, 然后调用EscapeSql函数对其进行过滤</li>
</ul>
<p>通过如上的代码分析不难得知其实$filename变量的内容我们是可控的, 只不过会经过一些函数对变量的内容进行一些过滤, 但此处并不影响删除文件漏洞的利用。回到我们的漏洞代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(@unlink(<span class="keyword">$this</span>-&gt;backupDir . $filename))&#123;</span><br><span class="line">				<span class="comment">//无动作</span></span><br></pre></td></tr></table></figure>
<p>在调用unlink函数时, 其参数是backupDir属性 + $filename变量。<br><img src="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/welive_delete_4.png" alt=""><br>backupDir属性值为程序的根目录 + &#39;config/&#39;, 当我们需要删除根目录的一个文件只需要构造file参数为../filename即可。此类漏洞可以配合一些在安装程序后通过判断其安装目录是否存在一个锁文件来验证程序是否安装的情况组合成重装程序的漏洞。<br><img src="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/welive_delete_5.png" alt=""></p>
<h4 id="任意文件下载"><a href="#任意文件下载" class="headerlink" title="任意文件下载"></a>任意文件下载</h4><p>  继续拿上面的那个客服系统做实战讲解,  在上一章节的漏洞分析中我们已经得知该系统通过ForceStringFrom函数获取的参数我们是可控的。因此本章节中不再重复赘述参数获取的过程。<br><img src="https://exp1orer.github.io/img/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/welive_download.png" alt=""><br>从上图的代码中能够看到在获取了file参数并赋值给$filename变量后只判断了文件是否存在, 而没有其他的一些验证,  随之调用readfile函数读取文件并输出。<br><strong>后话</strong><br>其实在该程序中, 此方法只是用于管理员在备份了数据库后能够下载备份文件, 但是由于在此没有验证文件是否为备份文件或做一下其他的限制策略, 那么此时就能够通过跨目录的形式做到下载任意文件。</p>
<h4 id="任意文件上传"><a href="#任意文件上传" class="headerlink" title="任意文件上传"></a>任意文件上传</h4><p>  任意文件上传漏洞通常出现在上传图片的地方, 开发者由于没有对上传格式执行严格的过滤或以白名单的形式验证文件后缀名的话, 攻击者就可以进行上传恶意的脚本文件(俗称Webshell)进而获取权限。 此处依旧引用DVWA漏洞靶场<br><strong>案例一</strong><br><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkuhlfgpp3j313q0gewiv.jpg" alt=""><br>上图代码中从$_FILES变量获取文件名称与路径进行拼接, 进而使用move_loadeded_file函数对文件进行移动。在这过程中并未对文件格式拓展名进行校验, 从而导致任意文件上传<br><strong>案例二</strong><br><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkuhz4d7kvj31920u0npd.jpg" alt=""><br>上图案例中程序虽然判断了文件的Content-Type类型是否为图像类型和文件的大小限制,但是依旧没有对文件的格式拓展名做校验, 所以此处依旧存在任意文件上传。</p>
<hr>
<p><strong>phpweb任意文件上传</strong><br>漏洞位于base/appborder.php<br><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkuicby054j314x0u0tk1.jpg" alt=""><br>上图代码中可以看到在进行目标路径和文件的拼接时并没有对文件拓展名进行验证, 而后便使用copy函数将上传的文件从临时路径移动至目标路径导致其任意文件上传。</p>
<hr>
<p><strong>EyouCMS V1.0.0任意文件上传</strong><br>漏洞位于api模块Uploadify控制器的preview方法, 对应文件：application/api/controller/Uploadify.php, 主要看201行开始的漏洞代码就可以了<br><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkz45dd99fj31120u0k4r.jpg" alt=""></p>
<blockquote>
<p>data:image/php;base64,PD9waHAgcGhwaW5mbygpOw==</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkz4c0zrl8j315x0u0gqg.jpg" alt=""><br><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkz4d83mk9j31uq0jozpq.jpg" alt=""></p>
<h4 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h4><p>  文件包含是每个应用程序必不可少的一部分, 因为代码不可能全部写在一个文件中,  因此就必须通过包含其他文件来调用其中的函数/对象, 但如果开发者在包含文件的地方拼接了用户的输入, 那么便有可能造成任意文件包含漏洞。而文件包含漏洞又分为LFI（本地文件包含）和RFI（远程文件包含）, 这取决于你的PHP配置项。</p>
<p><strong>示例一</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$page = $_GET[<span class="string">'page'</span>];</span><br><span class="line">define(<span class="string">"ROOT_PATH"</span>, <span class="string">"/var/www/html"</span>);</span><br><span class="line"><span class="keyword">include</span> ROOT_PATH . $page;</span><br></pre></td></tr></table></figure>
<p>如上代码中$page变量是攻击者可控的, 而程序在使用include包含文件时直接将文件的根目录与$变量进行拼接, 因此攻击者可通过跨目录的形式去包含任意文件（前提是你得知道路径）。<br><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkz5smczdjj32540dkq7z.jpg" alt=""></p>
<p><strong>示例二</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$file = $_GET[<span class="string">'page'</span>];</span><br><span class="line">$file = str_replace(<span class="keyword">array</span>(<span class="string">"http://"</span>, <span class="string">"https://"</span>), <span class="string">""</span>, $file);</span><br><span class="line">$file = str_replace(<span class="keyword">array</span>(<span class="string">"../"</span>, <span class="string">"..\""</span>), <span class="string">""</span>, $file);</span><br><span class="line"><span class="keyword">include</span> $file;</span><br></pre></td></tr></table></figure>
<p>上述代码中虽然对$file变量进行了过滤, 但只是把匹配的内容替换为空, 因此可通过双写的形式绕过此限制。构造Payload：<strong>…/./…/./…/./…/./…/./etc/passwd</strong><br><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkz69rzyqpj32240bsdks.jpg" alt=""></p>
<p><strong>phpmyadmin任意文件包含</strong></p>
<p>漏洞代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">    &amp;&amp; is_string($_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">    &amp;&amp; ! preg_match(<span class="string">'/^index/'</span>, $_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">    &amp;&amp; ! in_array($_REQUEST[<span class="string">'target'</span>], $target_blacklist)</span><br><span class="line">    &amp;&amp; Core::checkPageValidity($_REQUEST[<span class="string">'target'</span>]) </span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">include</span> $_REQUEST[<span class="string">'target'</span>];</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前四个条件很容易满足, 重点在最后一个方法, 跟进<strong>Core类checkPageValidity方法</strong>, 只要其为true那么就会包含$REQUEST[‘target’]。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkPageValidity</span><span class="params">(&amp;$page, array $whitelist = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($whitelist)) &#123;</span><br><span class="line">            $whitelist = <span class="keyword">self</span>::$goto_whitelist;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">            $page,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_page = urldecode($page);</span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">            $_page,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>假设传入Payload：target=tbl_sql.php%253f../../test.php, 进入函数中就会执行下图流程</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkz7wjink7j31370u045g.jpg" alt=""></p>
<h4 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h4><p>  XSS基于后端服务分为反射与存储型, 反射XSS又称非持久型。是因为其后端通过将用户输入的内容没有经过过滤便输出造成的漏洞。而存储型XSS常见于应用程序将用户输入的内容保存至数据库, 并且在某个地方又从数据库拿出该内容进行输出, 在PHP中常见于字符串输出的有echo, print, printf等语句。</p>
<p><strong>案例一</strong></p>
<p>  图中的代码直接使用echo拼接变量输出, 该变量为GET请求的name参数。</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkzdt5vzsmj317w0gkjtp.jpg" alt=""></p>
<blockquote>
<p>Payload：&lt;script&gt;alert(1)&lt;/script&gt;</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkzdunu6glj31dz0u0jvk.jpg" alt=""></p>
<p><strong>案例二</strong><br>下图的代码中使用str_replace函数将&lt;script&gt;标签替换为空, 这种过滤方式是非常不严谨的。只要使用双写或使用其他标签都可以绕过此方法。<br><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkzeddi3uyj31e60u0aea.jpg" alt=""></p>
<p><strong>案例三</strong></p>
<p>在下图的代码中, $message变量经过htmlspecialchars函数转换为HTML实体。但对于$name变量仅做了script标签的正则替换。因此我们可以通过其他标签来执行JavaScript代码。</p>
<blockquote>
<p>Payload：&lt;img/src/onerror=alert(1)&gt;</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkzf4xurlbj31e60t2448.jpg" alt=""></p>
<p><strong>某文章付费阅读系统XSS</strong></p>
<p>已知该系统定义了局部函数来过滤用户的输入, 所以直接跟进该函数寻找突破口即可。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">removexss</span><span class="params">($val)</span> </span>&#123;</span><br><span class="line">$val = preg_replace ( <span class="string">'/([\x00-\x08\x0b-\x0c\x0e-\x19])/'</span>, <span class="string">''</span>, $val );</span><br><span class="line"></span><br><span class="line">$search = <span class="string">'abcdefghijklmnopqrstuvwxyz'</span>;</span><br><span class="line">$search .= <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>;</span><br><span class="line">$search .= <span class="string">'1234567890!@#$%^&amp;*()'</span>;</span><br><span class="line">$search .= <span class="string">'~`";:?+/=&#123;&#125;[]-_|\'\\'</span>;</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen ( $search ); $i ++) &#123;</span><br><span class="line"></span><br><span class="line">$val = preg_replace ( <span class="string">'/(&amp;#[xX]0&#123;0,8&#125;'</span> . dechex ( ord ( $search [$i] ) ) . <span class="string">';?)/i'</span>, $search [$i], $val );</span><br><span class="line"></span><br><span class="line">$val = preg_replace ( <span class="string">'/(&amp;#0&#123;0,8&#125;'</span> . ord ( $search [$i] ) . <span class="string">';?)/'</span>, $search [$i], $val );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ra1 = <span class="keyword">array</span> (</span><br><span class="line"><span class="string">'javascript'</span>,</span><br><span class="line"><span class="string">'vbscript'</span>,</span><br><span class="line"><span class="string">'expression'</span>,</span><br><span class="line"><span class="string">'applet'</span>,</span><br><span class="line"><span class="string">'meta'</span>,</span><br><span class="line"><span class="string">'xml'</span>,</span><br><span class="line"><span class="string">'blink'</span>,</span><br><span class="line"><span class="string">'script'</span>,</span><br><span class="line"><span class="string">'object'</span>,</span><br><span class="line"><span class="string">'iframe'</span>,</span><br><span class="line"><span class="string">'frame'</span>,</span><br><span class="line"><span class="string">'frameset'</span>,</span><br><span class="line"><span class="string">'ilayer'</span>,</span><br><span class="line"><span class="string">'bgsound'</span></span><br><span class="line">);</span><br><span class="line">$ra2 = <span class="keyword">array</span> (</span><br><span class="line"><span class="string">'onabort'</span>,</span><br><span class="line"><span class="string">'onactivate'</span>,</span><br><span class="line"><span class="string">'onafterprint'</span>,</span><br><span class="line"><span class="string">'onafterupdate'</span>,</span><br><span class="line"><span class="string">'onbeforeactivate'</span>,</span><br><span class="line"><span class="string">'onbeforecopy'</span>,</span><br><span class="line"><span class="string">'onbeforecut'</span>,</span><br><span class="line"><span class="string">'onbeforedeactivate'</span>,</span><br><span class="line"><span class="string">'onbeforeeditfocus'</span>,</span><br><span class="line"><span class="string">'onbeforepaste'</span>,</span><br><span class="line"><span class="string">'onbeforeprint'</span>,</span><br><span class="line"><span class="string">'onbeforeunload'</span>,</span><br><span class="line"><span class="string">'onbeforeupdate'</span>,</span><br><span class="line"><span class="string">'onbegin'</span>,</span><br><span class="line"><span class="string">'onblur'</span>,</span><br><span class="line"><span class="string">'onbounce'</span>,</span><br><span class="line"><span class="string">'oncellchange'</span>,</span><br><span class="line"><span class="string">'onchange'</span>,</span><br><span class="line"><span class="string">'onclick'</span>,</span><br><span class="line"><span class="string">'oncontextmenu'</span>,</span><br><span class="line"><span class="string">'oncontrolselect'</span>,</span><br><span class="line"><span class="string">'oncopy'</span>,</span><br><span class="line"><span class="string">'oncut'</span>,</span><br><span class="line"><span class="string">'ondataavailable'</span>,</span><br><span class="line"><span class="string">'ondatasetchanged'</span>,</span><br><span class="line"><span class="string">'ondatasetcomplete'</span>,</span><br><span class="line"><span class="string">'ondblclick'</span>,</span><br><span class="line"><span class="string">'ondeactivate'</span>,</span><br><span class="line"><span class="string">'ondrag'</span>,</span><br><span class="line"><span class="string">'ondragend'</span>,</span><br><span class="line"><span class="string">'ondragenter'</span>,</span><br><span class="line"><span class="string">'ondragleave'</span>,</span><br><span class="line"><span class="string">'ondragover'</span>,</span><br><span class="line"><span class="string">'ondragstart'</span>,</span><br><span class="line"><span class="string">'ondrop'</span>,</span><br><span class="line"><span class="string">'onerror'</span>,</span><br><span class="line"><span class="string">'onerrorupdate'</span>,</span><br><span class="line"><span class="string">'onfilterchange'</span>,</span><br><span class="line"><span class="string">'onfinish'</span>,</span><br><span class="line"><span class="string">'onfocus'</span>,</span><br><span class="line"><span class="string">'onfocusin'</span>,</span><br><span class="line"><span class="string">'onfocusout'</span>,</span><br><span class="line"><span class="string">'onhelp'</span>,</span><br><span class="line"><span class="string">'onkeydown'</span>,</span><br><span class="line"><span class="string">'onkeypress'</span>,</span><br><span class="line"><span class="string">'onkeyup'</span>,</span><br><span class="line"><span class="string">'onlayoutcomplete'</span>,</span><br><span class="line"><span class="string">'onload'</span>,</span><br><span class="line"><span class="string">'onlosecapture'</span>,</span><br><span class="line"><span class="string">'onmousedown'</span>,</span><br><span class="line"><span class="string">'onmouseenter'</span>,</span><br><span class="line"><span class="string">'onmouseleave'</span>,</span><br><span class="line"><span class="string">'onmousemove'</span>,</span><br><span class="line"><span class="string">'onmouseout'</span>,</span><br><span class="line"><span class="string">'onmouseover'</span>,</span><br><span class="line"><span class="string">'onmouseup'</span>,</span><br><span class="line"><span class="string">'onmousewheel'</span>,</span><br><span class="line"><span class="string">'onmove'</span>,</span><br><span class="line"><span class="string">'onmoveend'</span>,</span><br><span class="line"><span class="string">'onmovestart'</span>,</span><br><span class="line"><span class="string">'onpaste'</span>,</span><br><span class="line"><span class="string">'onpropertychange'</span>,</span><br><span class="line"><span class="string">'onreadystatechange'</span>,</span><br><span class="line"><span class="string">'onreset'</span>,</span><br><span class="line"><span class="string">'onresize'</span>,</span><br><span class="line"><span class="string">'onresizeend'</span>,</span><br><span class="line"><span class="string">'onresizestart'</span>,</span><br><span class="line"><span class="string">'onrowenter'</span>,</span><br><span class="line"><span class="string">'onrowexit'</span>,</span><br><span class="line"><span class="string">'onrowsdelete'</span>,</span><br><span class="line"><span class="string">'onrowsinserted'</span>,</span><br><span class="line"><span class="string">'onscroll'</span>,</span><br><span class="line"><span class="string">'onselect'</span>,</span><br><span class="line"><span class="string">'onselectionchange'</span>,</span><br><span class="line"><span class="string">'onselectstart'</span>,</span><br><span class="line"><span class="string">'onstart'</span>,</span><br><span class="line"><span class="string">'onstop'</span>,</span><br><span class="line"><span class="string">'onsubmit'</span>,</span><br><span class="line"><span class="string">'ontoggle'</span>,</span><br><span class="line"><span class="string">'onunload'</span></span><br><span class="line">);</span><br><span class="line">$ra = array_merge ( $ra1, $ra2 );</span><br><span class="line"></span><br><span class="line">$found = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">while</span> ( $found == <span class="keyword">true</span> ) &#123;</span><br><span class="line">$val_before = $val;</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; sizeof ( $ra ); $i ++) &#123;</span><br><span class="line">$pattern = <span class="string">'/'</span>;</span><br><span class="line"><span class="keyword">for</span>($j = <span class="number">0</span>; $j &lt; strlen ( $ra [$i] ); $j ++) &#123;</span><br><span class="line"><span class="keyword">if</span> ($j &gt; <span class="number">0</span>) &#123;</span><br><span class="line">$pattern .= <span class="string">'('</span>;</span><br><span class="line">$pattern .= <span class="string">'(&amp;#[xX]0&#123;0,8&#125;([9ab]);)'</span>;</span><br><span class="line">$pattern .= <span class="string">'|'</span>;</span><br><span class="line">$pattern .= <span class="string">'|(&amp;#0&#123;0,8&#125;([9|10|13]);)'</span>;</span><br><span class="line">$pattern .= <span class="string">')*'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$pattern .= $ra [$i] [$j];</span><br><span class="line">&#125;</span><br><span class="line">$pattern .= <span class="string">'/i'</span>;</span><br><span class="line">$replacement = substr ( $ra [$i], <span class="number">0</span>, <span class="number">2</span> ) . <span class="string">' '</span> . substr ( $ra [$i], <span class="number">2</span> );</span><br><span class="line">$val = preg_replace ( $pattern, $replacement, $val );</span><br><span class="line"><span class="keyword">if</span> ($val_before == $val) &#123;</span><br><span class="line"></span><br><span class="line">$found = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义了黑名单标签和属性$ra, 然后循环将黑名单的子字符从0的索引截取两个长度并添加空格再拼接剩余字符, 然后使用preg_replace正则匹配如果传入的参数匹配成功则替换为如上添加空格后的内容。简单理解：你传入一个<strong>&lt;script&gt;</strong>标签, 经过该函数过滤后会变为<strong>&lt;sc ript&gt;</strong>。因此如果需要绕过该黑名单就需要找一个不再此黑名单中的标签和属性, 最终我找到了<strong>svg</strong>标签和<strong>onrepeat</strong>属性。</p>
<blockquote>
<p>&lt;svg&gt;&lt;animate onrepeat=alert(1) attributeName=x dur=1s repeatCount=2 /&gt;</p>
</blockquote>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/exp1orer" target="_blank" rel="noopener">项目</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#TL-DR"><span class="toc-number">1.</span> <span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#前序知识"><span class="toc-number">2.</span> <span class="toc-text">前序知识</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL注入"><span class="toc-number">3.</span> <span class="toc-text">SQL注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#熊海CMS-V1-0-SQL注入"><span class="toc-number">4.</span> <span class="toc-text">熊海CMS V1.0 SQL注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#任意文件删除"><span class="toc-number">5.</span> <span class="toc-text">任意文件删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#任意文件下载"><span class="toc-number">6.</span> <span class="toc-text">任意文件下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#任意文件上传"><span class="toc-number">7.</span> <span class="toc-text">任意文件上传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#文件包含"><span class="toc-number">8.</span> <span class="toc-text">文件包含</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XSS"><span class="toc-number">9.</span> <span class="toc-text">XSS</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&text=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&title=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&is_video=false&description=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PHP代码审计入门&body=Check out this article: http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&title=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&title=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&title=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&title=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&name=PHP代码审计入门&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://yoursite.com/2020/11/17/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/&t=PHP代码审计入门" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2021
    Search?=Null
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/exp1orer" target="_blank" rel="noopener">项目</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
